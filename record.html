<!doctype html>
<html>
  <head>
    <title>Dublin Bike Parking</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
      integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
      crossorigin="">
    <style type="text/css">
      html, body {height:100%;}

      #map {
        width:100%;
        height:34%;
      }
      .info { padding: 6px 8px; font: 14px/16px Arial, Helvetica, sans-serif; background: white; background: rgba(255,255,255,0.8); box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; } .info h4 { margin: 0 0 5px; color: #777; }
      .legend { text-align: left; line-height: 18px; color: #555; }

      .btn-add { width:100%;height:100px;}
    </style>
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
      integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
      crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-ajax@2.1.0/dist/leaflet.ajax.min.js"
      integrity="sha384-sKs8ZrrxyJoElcPVznZwGpUTTXvkMYfHYxdIFzO8Hd0TA6emONMj8BwnsFf+6cZ/"
      crossorigin=""></script>
    <script src="https://unpkg.com/nosleep.js@0.7.0/dist/NoSleep.min.js" integrity="sha384-cR9Tx9898BigGUVSuwWg4H4lAs65FxW5vlKAos37rTe76eT+uki9wMw3N+DnhUTn" crossorigin="anonymous"></script>
    <script type="text/javascript">
      window.addEventListener('load', function() {
        var map = L.map('map').setView([53.34587706183283, -6.267379465984959], 12);

        var StandIcon = L.Icon.extend({
          options: {
            iconSize: [22,22]
          }
        })
        var sheffieldStand = new StandIcon({iconUrl: 'stand_icon_sheffield.png'})
        var curvedStand = new StandIcon({iconUrl: 'stand_icon_ssc.png'})
        var hoopStand = new StandIcon({iconUrl: 'stand_icon_hoop.png'})
        var dublinBikesStand = new StandIcon({iconUrl: 'station_icon_db.png'})

        L.tileLayer('https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        var geojsonLayer = new L.GeoJSON.AJAX("BikeParkingIDs.geojson",{onEachFeature:popUp});
        geojsonLayer.getAttribution = function() { return 'Bike Parking: <a href="https://data.smartdublin.ie/dataset/dcc_public_cycle_parking_stands">Dublin City Council CC-BY 4.0</a>'; };
        geojsonLayer.addTo(map);

        var dublinBikesLayer = new L.GeoJSON.AJAX("DublinBikes.geojson",{onEachFeature:dbPopUp});
        dublinBikesLayer.getAttribution = function() { return 'DublinBikes: <a href="https://developer.jcdecaux.com/#/opendata/vls?page=getstarted&contract=Dublin">JCDecaux</a>'; };
        dublinBikesLayer.addTo(map);

        function dbPopUp(f,l){
          l.setIcon(dublinBikesStand);
        }

        function popUp(f,l){
          var icon;

          switch(f.properties["type_stands"]) {
              case "Sheffield Stand":
                icon = sheffieldStand;
                break;
              case "Stainless Steel Curved":
                icon = curvedStand;
                break;
              case "Hoops":
                icon = hoopStand;
                break;
              case "Railing":
                icon = sheffieldStand;
                break;
              default:
                icon = sheffieldStand;
          }

          l.setIcon(icon);
        }

        var currentLocationMarker = L.circleMarker([0,0]).addTo(map)
        if ("geolocation" in navigator) {
          var watchID = navigator.geolocation.watchPosition(function(position) {
            var radius = position.coords.accuracy / 2;

            currentLocationMarker.setLatLng([position.coords.latitude, position.coords.longitude]);
            currentLocationMarker.setRadius(radius);

            map.setView([position.coords.latitude, position.coords.longitude],20)
          });
        } else {
          /* geolocation IS NOT available */
        }

        document.getElementById('add').addEventListener('click', function() {
          var ll = currentLocationMarker.getLatLng();
          var data = {
            no_stands: document.querySelector('input[name=no_stands]:checked').value,
            type: document.querySelector('input[name=type]:checked').value,
            lat: ll.lat,
            lng: ll.lng
          };

          var request = new XMLHttpRequest();
          request.open('POST', '/post.php', true);
          request.setRequestHeader('Content-Type', 'application/json; charset=UTF-8');
          request.send(JSON.stringify(data));

          //document.location = "/record.html"
        });

        var noSleep = new NoSleep();

        function enableNoSleep() {
          noSleep.enable();
          document.removeEventListener('click', enableNoSleep, false);
          document.getElementById('wl').classList.add('btn-success')
          document.getElementById('wl').classList.remove('btn-primary')
        }

        // Enable wake lock.
        // (must be wrapped in a user input event handler e.g. a mouse or touch handler)
        document.getElementById('wl').addEventListener('click', enableNoSleep, false);
      });
    </script>
  </head>
  <body>
    <div id="map">
    </div>
    <div class="container">
      <h1>Add stand</h1>
      <div class="btn-group" data-toggle="buttons">
        <label class="btn btn-primary">
          <input type="radio" name="no_stands" id="option1" value="1">1
        </label>
        <label class="btn btn-primary">
          <input type="radio" name="no_stands" id="option2" value="2">2
        </label>
        <label class="btn btn-primary">
          <input type="radio" name="no_stands" id="option3" value="3">3
        </label>
        <label class="btn btn-primary">
          <input type="radio" name="no_stands" id="option4" value="4">4
        </label>
        <label class="btn btn-primary">
          <input type="radio" name="no_stands" id="option5" value="5">5
        </label>
        <label class="btn btn-primary">
          <input type="radio" name="no_stands" id="option6" value="6">6
        </label>
        <label class="btn btn-primary">
          <input type="radio" name="no_stands" id="optiono" value="o"><input type="number" name="no_stands_o" min="0" max="20">
        </label>
      </div>
      <div class="btn-group" data-toggle="buttons">
        <label class="btn btn-primary">
          <input type="radio" name="type" id="option1" value="Sheffield Stand">Sheffield
        </label>
        <label class="btn btn-primary">
          <input type="radio" name="type" id="option2" value="Hoop">Hoop
        </label>
        <label class="btn btn-primary">
          <input type="radio" name="type" id="option3" value="Railing">Railing
        </label>
        <label class="btn btn-primary">
          <input type="radio" name="type" id="option4" value="ssc">SSC
        </label>
      </div>
      <div class="row">
        <div class="col-12 text-center">
          <button class="btn btn-lg btn-primary btn-add" id="add">Add stand</button>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <button class="btn btn-primary" id="wl">wakelock</button>
        </div>
      </div>
    </div>
  </body>
</html>
